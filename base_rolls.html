<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RED Winter Character Sheet Roller</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0b1020;
        --panel: rgba(255, 255, 255, 0.06);
        --border: rgba(255, 255, 255, 0.14);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.7);
        --accent: #7dd3fc;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New",
          monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
      }

      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f6f7fb;
          --panel: rgba(0, 0, 0, 0.04);
          --border: rgba(0, 0, 0, 0.12);
          --text: rgba(0, 0, 0, 0.88);
          --muted: rgba(0, 0, 0, 0.62);
          --shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        }
      }

      html,
      body {
        height: 100%;
        min-height: 100%;
        background: radial-gradient(1200px 600px at 20% 10%, rgba(125, 211, 252, 0.18), transparent 60%),
          radial-gradient(900px 600px at 80% 95%, rgba(34, 197, 94, 0.10), transparent 55%),
          var(--bg);
        background-attachment: fixed;
        background-repeat: no-repeat;
      }
	body {
        min-height: 100vh;
        margin: 0;
        background: transparent;
        color: var(--text);
        font-family: var(--sans);
        line-height: 1.35;
      }

      .wrap {
        max-width: 980px;
        margin: 28px auto;
        padding: 0 18px 44px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
        margin-bottom: 14px;
      }

      h1 {
        font-size: 20px;
        margin: 0 0 6px 0;
      }

      .subtitle {
        color: var(--muted);
        font-size: 13px;
        margin: 0;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 14px;
        box-shadow: var(--shadow);
      }

      .controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px 12px;
        align-items: end;
      }

      @media (max-width: 820px) {
        .controls {
          grid-template-columns: 1fr;
        }
      }

      label {
        display: block;
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 6px;
      }

      input[type="file"],
      input[type="text"] {
        width: 100%;
        box-sizing: border-box;
        border-radius: 10px;
        border: 1px solid var(--border);
        padding: 10px 10px;
        background: rgba(0, 0, 0, 0.14);
        color: var(--text);
      }

      @media (prefers-color-scheme: light) {
        input[type="file"],
        input[type="text"] {
          background: rgba(255, 255, 255, 0.7);
        }
      }

      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }

      .muted {
        color: var(--muted);
      }

      .mono {
        font-family: var(--mono);
        font-size: 12.5px;
      }

      .meta {
        font-size: 13px;
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
        margin-top: 10px;
      }

      .pill {
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 5px 9px;
        background: rgba(0, 0, 0, 0.10);
      }

      @media (prefers-color-scheme: light) {
        .pill {
          background: rgba(255, 255, 255, 0.6);
        }
      }

      .error {
        color: #fb7185;
        font-size: 13px;
        margin-top: 10px;
        white-space: pre-wrap;
      }

      .list {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 12px;
      }

      @media (max-width: 820px) {
        .list {
          grid-template-columns: 1fr;
        }
      }

      .card {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.10);
      }

      @media (prefers-color-scheme: light) {
        .card {
          background: rgba(255, 255, 255, 0.6);
        }
      }

      .card h2 {
        margin: 0;
        font-size: 14px;
        letter-spacing: 0.15px;
      }

      .value {
        margin-top: 6px;
        color: var(--muted);
        font-size: 12px;
      }

      .valueRow {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .modBox {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      input.modInput[type="text"] {
        width: 86px;
        padding: 6px 8px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.14);
        color: var(--text);
        box-sizing: border-box;
      }

      @media (prefers-color-scheme: light) {
        input.modInput[type="text"] {
          background: rgba(255, 255, 255, 0.7);
        }
      }

      .cardActions {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      button {
        border-radius: 10px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        background: rgba(0, 0, 0, 0.14);
        color: var(--text);
        cursor: pointer;
      }

      button:hover {
        border-color: rgba(125, 211, 252, 0.55);
      }

      .toast {
        margin-left: auto;
        font-size: 12px;
        color: var(--muted);
      }

      .hint {
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted);
      }

      .modalBackdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
        z-index: 50;
      }

      .modalBackdrop[data-open="true"] {
        display: flex;
      }

      .modal {
        width: min(560px, 100%);
        border-radius: 16px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.25);
        box-shadow: var(--shadow);
        padding: 14px;
        backdrop-filter: blur(10px);
      }

      @media (prefers-color-scheme: light) {
        .modal {
          background: rgba(255, 255, 255, 0.85);
        }
      }

      .modalTitle {
        margin: 0;
        font-size: 14px;
      }

      .modalSub {
        margin: 6px 0 0 0;
        font-size: 12px;
        color: var(--muted);
      }

      .modalActions {
        margin-top: 12px;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .modalActions .right {
        margin-left: auto;
      }

      a {
        color: var(--accent);
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div>
          <h1>RED Winter Character Sheet Roller</h1>
        </div>
        <div class="panel" style="max-width: 420px">
          <div class="muted" style="font-size: 12px">
            Uses <a href="https://pdf-lib.js.org/" target="_blank" rel="noreferrer">pdf-lib</a> locally in your browser.
            Nothing is uploaded.
          </div>
        </div>
      </header>

      <section class="panel">
        <div class="controls">
          <div>
            <label for="file">PDF file</label>
            <input id="file" type="file" accept="application/pdf,.pdf" />
          </div>
          <div>
            <label for="search">Filter (display name contains)</label>
            <input id="search" type="text" placeholder="e.g. Athletics, Awareness" />
          </div>
          <div class="row">
            <span class="muted" style="font-size: 12px">Modifier prompt expects text like <span class="mono">+2</span> or <span class="mono">-1</span>.</span>
          </div>
        </div>

        <div class="meta" id="meta" aria-live="polite"></div>
        <div class="error" id="error" hidden></div>

        <div id="list" class="list" hidden></div>

      </section>
    </div>

    <div id="modalBackdrop" class="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal">
        <h2 id="modalTitle" class="modalTitle">Modifer?</h2>
        <p id="modalSub" class="modalSub"></p>
        <div style="margin-top: 10px">
          <label for="modifierInput">Modifier (optional)</label>
          <input id="modifierInput" type="text" placeholder="+2" autocomplete="off" />
        </div>
        <div class="modalActions">
          <button id="cancelBtn" type="button">Cancel</button>
          <button id="copyBtn" class="right" type="button">Copy</button>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script>
      const fileInput = document.getElementById("file");
      const searchInput = document.getElementById("search");
      const metaEl = document.getElementById("meta");
      const errorEl = document.getElementById("error");
      const listEl = document.getElementById("list");
      const modalBackdrop = document.getElementById("modalBackdrop");
      const modalSub = document.getElementById("modalSub");
      const modifierInput = document.getElementById("modifierInput");
      const cancelBtn = document.getElementById("cancelBtn");
      const copyBtn = document.getElementById("copyBtn");

      const BASE_PREFIX = "BASE ";
      // When the PDF uses compressed/abbreviated field suffixes (e.g. "HumanPerception"),
      // display the normal spaced name (e.g. "Human Perception"). Case-insensitive.
      const BASE_NAME_MAP = {
        AnimalHandling: "Animal Handling",
        AVTech: "Air Vehicle Tech",
        BasicTech: "Basic Tech",
        Conceal: "Conceal/Reveal",
        Contortion: "Contortionist",
        Cybertech: "CyberTech",
        DLV: "Drive Land Vehicle",
        ElecSec: "Electronics/Security Tech",
        FirstAid: "First Aid",
        HeavyWeapons: "Heavy Weapons",
        HumanPerception: "Human Perception",
        Lang1: "(name of a language)",
        LibrarySearch: "Library Search",
        LipReading: "Lip Reading",
        LVTech: "Land Vehicle Tech",
        Martial: "Martial Arts",
        Melee: "Melee Weapon",
        PAV: "Pilot Air Vehicle",
        PDSculpt: "Paint/Draw/Sculpt",
        PersonalGrooming: "Personal Grooming",
        PhotoFilm: "Photography/Film",
        PickLock: "Pick Lock",
        PickPocket: "Pick Pocket",
        PSV: "Pilot Sea Vehicle",
        RTD: "Resist Torture/Drugs",
        ShoulderArms: "Shoulder Arms",
        SVTech: "Sea Vehicle Tech",
        WardrobeStyle: "Wardrobe & Style",
        WeaponsTech: "Weaponstech",
        Wilderness: "Wilderness Survival",
      };
      const BASE_NAME_MAP_LOWER = Object.fromEntries(
        Object.entries(BASE_NAME_MAP).map(([k, v]) => [String(k).toLowerCase(), v])
      );
      let lastItems = [];
      let pendingItem = null;
      let pendingToast = null;

      function setError(message) {
        if (!message) {
          errorEl.hidden = true;
          errorEl.textContent = "";
          return;
        }
        errorEl.hidden = false;
        errorEl.textContent = message;
      }

      function setMeta(pills) {
        metaEl.textContent = "";
        for (const pill of pills) {
          const el = document.createElement("div");
          el.className = "pill";
          el.textContent = pill;
          metaEl.appendChild(el);
        }
      }

      function normalizeValue(value) {
        if (value === undefined || value === null) return "";
        if (typeof value === "string") return value;
        if (typeof value === "boolean") return value ? "true" : "false";
        if (Array.isArray(value)) return value.join(", ");
        try {
          return JSON.stringify(value);
        } catch {
          return String(value);
        }
      }

      function normalizeModPrefill(value) {
        const text = String(normalizeValue(value)).trim();
        if (!text) return "";
        if (/^[-+]?0+(?:\\.0+)?$/.test(text)) return "";
        return text.startsWith("+") ? text.slice(1) : text;
      }

      function normalizeModifierForRoll(text) {
        const mod = String(text ?? "").trim();
        if (!mod) return "";
        if (mod.startsWith("+") || mod.startsWith("-")) return mod;
        return `+${mod}`;
      }

      function openModal(item, toastEl) {
        pendingItem = item;
        pendingToast = toastEl;
        modalSub.textContent = `${item.displayName} (value: ${normalizeValue(item.rawValue)})`;
        modifierInput.value = normalizeModifierForRoll(item.modText);
        modalBackdrop.dataset.open = "true";
        setTimeout(() => modifierInput.focus(), 0);
      }

      function closeModal() {
        modalBackdrop.dataset.open = "false";
        pendingItem = null;
        pendingToast = null;
      }

      function getFieldValue(field) {
        try {
          if (typeof field.getText === "function") return field.getText() ?? "";
        } catch {}
        try {
          if (typeof field.isChecked === "function") return field.isChecked();
        } catch {}
        try {
          if (typeof field.getSelected === "function") return field.getSelected() ?? "";
        } catch {}
        return "";
      }

      function getPrettyBaseName(rawSuffix) {
        const key = String(rawSuffix ?? "");
        if (!key) return key;
        return BASE_NAME_MAP[key] ?? BASE_NAME_MAP_LOWER[key.toLowerCase()] ?? key;
      }

      function normalizeFreeTextName(value) {
        return String(normalizeValue(value)).replace(/\s+/g, " ").trim();
      }

      function getDynamicBaseName(rawSuffix, valueByFieldNameLower) {
        const suffix = String(rawSuffix ?? "");
        if (!suffix) return "";

        let match = suffix.match(/^Lang(\d+)$/i);
        if (match) {
          const index = match[1];
          const languageName = normalizeFreeTextName(valueByFieldNameLower?.[`lang${index}`]);
          return languageName ? `Language: ${languageName}` : `Language ${index}`;
        }

        match = suffix.match(/^LocalExpert(\d+)$/i);
        if (match) {
          const index = match[1];
          const areaName = normalizeFreeTextName(valueByFieldNameLower?.[`txt_localexpert${index}`]);
          return areaName ? `Local Expert: ${areaName}` : `Local Expert ${index}`;
        }

        match = suffix.match(/^Science(\d+)$/i);
        if (match) {
          const index = match[1];
          const scienceName = normalizeFreeTextName(valueByFieldNameLower?.[`txt_science${index}`]);
          return scienceName ? `Science: ${scienceName}` : `Science ${index}`;
        }

        match = suffix.match(/^PlayInstrument(\d+)$/i);
        if (match) {
          const index = match[1];
          const instrumentName = normalizeFreeTextName(
            valueByFieldNameLower?.[`txt playinstrument${index}`] ?? valueByFieldNameLower?.[`txt_playinstrument${index}`]
          );
          return instrumentName ? `Play Instrument: ${instrumentName}` : `Play Instrument ${index}`;
        }

        return "";
      }

      function getDisplayBaseName(rawSuffix, valueByFieldNameLower) {
        return getDynamicBaseName(rawSuffix, valueByFieldNameLower) || getPrettyBaseName(rawSuffix);
      }

      function render() {
        const needle = searchInput.value.trim().toLowerCase();
        const items = lastItems
          .filter((it) => (needle ? it.displayName.toLowerCase().includes(needle) : true))
          .sort((a, b) => a.displayName.toLowerCase().localeCompare(b.displayName.toLowerCase()));

        listEl.textContent = "";
        listEl.hidden = items.length === 0;

        for (const item of items) {
          const card = document.createElement("div");
          card.className = "card";

          const title = document.createElement("h2");
          title.textContent = item.displayName;

          const value = document.createElement("div");
          value.className = "value mono valueRow";

          const valueText = document.createElement("span");
          valueText.textContent = `Value: ${normalizeValue(item.rawValue)}`;

          const modBox = document.createElement("span");
          modBox.className = "modBox";

          const modLabel = document.createElement("span");
          modLabel.textContent = "MOD:";

          const modInput = document.createElement("input");
          modInput.type = "text";
          modInput.className = "modInput";
          modInput.autocomplete = "off";
          modInput.inputMode = "numeric";
          modInput.placeholder = "";
          modInput.value = item.modText || "";
          modInput.addEventListener("input", () => {
            item.modText = modInput.value.trim();
          });
          modInput.addEventListener("blur", () => {
            item.modText = normalizeModPrefill(modInput.value);
            modInput.value = item.modText;
          });

          modBox.appendChild(modLabel);
          modBox.appendChild(modInput);

          value.appendChild(valueText);
          value.appendChild(modBox);

          const actions = document.createElement("div");
          actions.className = "cardActions";

          const btn = document.createElement("button");
          btn.textContent = `Roll ${item.displayName}`;
          btn.addEventListener("click", () => openModal(item, toast));

          const toast = document.createElement("div");
          toast.className = "toast";

          actions.appendChild(btn);
          actions.appendChild(toast);

          card.appendChild(title);
          card.appendChild(value);
          card.appendChild(actions);
          listEl.appendChild(card);
        }
      }

      async function parsePdf(file) {
        setError("");
        setMeta([`Loading: ${file.name}`]);
        listEl.textContent = "";
        listEl.hidden = true;
        lastItems = [];

        if (!window.PDFLib?.PDFDocument) {
          throw new Error("pdf-lib failed to load. Refresh the page and try again.");
        }

        const bytes = await file.arrayBuffer();
        const pdfDoc = await PDFLib.PDFDocument.load(bytes, { ignoreEncryption: true });

        let fields = [];
        try {
          const form = pdfDoc.getForm();
          fields = form.getFields();
        } catch {
          fields = [];
        }

        const valueByFieldNameLower = {};
        for (const field of fields) {
          const fieldName = String(field.getName?.() ?? "");
          if (!fieldName) continue;
          valueByFieldNameLower[fieldName.toLowerCase()] = getFieldValue(field);
        }

        const items = [];
        for (const field of fields) {
          const name = String(field.getName?.() ?? "");
          if (!name.startsWith(BASE_PREFIX)) continue;
          const rawSuffix = name.slice(BASE_PREFIX.length);
          const displayName = getDisplayBaseName(rawSuffix, valueByFieldNameLower);
          const rawValue = getFieldValue(field);

          const modFieldNameLower = (`MOD ${rawSuffix}`).toLowerCase();
          const modRawValue = valueByFieldNameLower[modFieldNameLower];
          const modText = normalizeModPrefill(modRawValue);

          items.push({ name, displayName, rawValue, modText });
        }

        lastItems = items;
        setMeta([
          `File: ${file.name}`,
          `Pages: ${pdfDoc.getPageCount()}`,
          `BASE fields: ${items.length}`,
          `Name map: embedded (${Object.keys(BASE_NAME_MAP).length})`,
        ]);
        render();
      }

      fileInput.addEventListener("change", async () => {
        const file = fileInput.files?.[0];
        if (!file) return;
        try {
          await parsePdf(file);
        } catch (e) {
          setMeta([`File: ${file.name}`]);
          setError(String(e?.stack || e?.message || e));
        }
      });

      function buildRollText(item, modifierText) {
        const mod = normalizeModifierForRoll(modifierText);
        return `!r 1d10+${normalizeValue(item.rawValue)}${mod}  ${item.displayName}`;
      }

      async function copyRoll() {
        if (!pendingItem) return;
        modifierInput.value = normalizeModifierForRoll(modifierInput.value);
        const rollText = buildRollText(pendingItem, modifierInput.value);
        try {
          await navigator.clipboard.writeText(rollText);
          if (pendingToast) {
            pendingToast.textContent = "Copied to clipboard";
            clearTimeout(pendingToast._t);
            pendingToast._t = setTimeout(() => (pendingToast.textContent = ""), 1100);
          }
          closeModal();
        } catch (e) {
          closeModal();
          window.alert(`Could not copy to clipboard.\\n\\n${rollText}`);
        }
      }

      modalBackdrop.addEventListener("click", (e) => {
        if (e.target === modalBackdrop) closeModal();
      });
      cancelBtn.addEventListener("click", closeModal);
      copyBtn.addEventListener("click", copyRoll);
      modifierInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") copyRoll();
        if (e.key === "Escape") closeModal();
      });

      searchInput.addEventListener("input", render);
      setMeta(["Select a PDF to begin"]);
    </script>
  </body>
</html>
